name: CITS3007 Project CI

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsodium-dev check valgrind
        
    - name: Verify libraries.txt
      run: |
        grep -q "libsodium" libraries.txt || echo "libsodium" >> libraries.txt
        grep -q "check" libraries.txt || echo "check" >> libraries.txt
        
    - name: Build and run tests with ASan
      run: |
        make clean
        # Build with ASan flags
        gcc -g -fsanitize=address -fno-omit-frame-pointer -std=c11 -pedantic-errors -Wall -Wextra -Wshadow -Wconversion -O0 -Werror=vla -Werror=implicit-function-declaration -fstack-protector-strong -Isrc -pthread -DTESTING -o test/test_account test/test_account.c src/account.c src/stubs.c -Isrc -lsodium -lcheck_pic -pthread -lrt -lm -lsubunit -lcheck -lsubunit -pthread -lrt -lm
        # Verify binary exists
        test -f test/test_account || exit 1
        # Run tests with ASan
        ./test/test_account
        
    - name: Build and run tests with Valgrind
      run: |
        make clean
        # Build without sanitizers for Valgrind
        gcc -g -O0 -fno-omit-frame-pointer -std=c11 -pedantic-errors -Wall -Wextra -Wshadow -Wconversion -Werror=vla -Werror=implicit-function-declaration -fstack-protector-strong -Isrc -pthread -DTESTING -o test/test_account test/test_account.c src/account.c src/stubs.c -Isrc -lsodium -lcheck_pic -pthread -lrt -lm -lsubunit -lcheck -lsubunit -pthread -lrt -lm
        # Verify binary exists
        test -f test/test_account || exit 1
        # Run Valgrind with strict checks
        valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --error-exitcode=1 --track-fds=yes --trace-children=yes ./test/test_account

  static-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tools
        
    - name: Run Cppcheck on implementation files
      run: |
        # Run strict checks on the implementation files you need to submit
        cppcheck --enable=all --suppress=missingIncludeSystem --suppress=unusedFunction --error-exitcode=1 \
          src/account.c src/login.c
        
    - name: Run Cppcheck on test files
      run: |
        # Check test files but with fewer restrictions
        cppcheck --enable=all --suppress=missingIncludeSystem \
           --error-exitcode=1 \
          test/
  