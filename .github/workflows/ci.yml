name: CITS3007 Project CI

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsodium-dev check valgrind
        
    - name: Verify libraries.txt
      run: |
        grep -q "libsodium" libraries.txt || echo "libsodium" >> libraries.txt
        grep -q "check" libraries.txt || echo "check" >> libraries.txt
        
    - name: Build project
      run: make all
      
    - name: Run tests with sanitizers
      run: |
        make test
        
    - name: Run Valgrind memory check
      run: |
        for test in test_*; do
          if [ -x "$test" ]; then
            echo "Running Valgrind on $test"
            valgrind --leak-check=full --error-exitcode=1 ./$test
          fi
        done

  static-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tools
        
    - name: Run Cppcheck on implementation files
      run: |
        # Run strict checks on the implementation files you need to submit
        cppcheck --enable=all --suppress=missingIncludeSystem --suppress=unusedFunction --error-exitcode=1 \
          src/account.c src/login.c
        
    - name: Run Cppcheck on test files
      run: |
        # Check test files but with fewer restrictions
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --suppress=unusedFunction --error-exitcode=1 \
          test/
  